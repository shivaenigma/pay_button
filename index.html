<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	<title>Bootstrap 101 Template</title>

	<!-- Bootstrap -->
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	
	<link rel="stylesheet" href="custom.css">

	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
	
	<a href="#" id="blockoPayBtn" data-toggle="modal" data-uid="74d5fffe4ad811e7">
		<img src="https://pbs.twimg.com/media/B-UEfIjIUAA8kFQ.png:large" width="120">
	</a>
	
	<style>
		
		
		
	</style>
	
	
	<!-- Modal -->
	<div class="modal fade" id="blockoPayModal" tabindex="-1" role="dialog" aria-labelledby="blockoPayModalLabel">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Blockonomics</h4>
				</div>
				<div class="modal-body">
					<form action="http://localhost:8080/merchant_order/" id="blockoPayBtnForm">
						<div class="form-group">
							<input type="text" class="form-control" id="blockoPayBtnName" name="blockoPayBtnName" required placeholder="Name">
						</div>
						<div class="form-group">
							<input type="email" class="form-control" id="blockoPayBtnEmail" name="blockoPayBtnEmail" required placeholder="Email">
						</div>
						
						<div id="blockoPayBtnMessage"></div>
						
						<div class="form-group centered">
							<button type="submit" class="btn btn-warning" id="blockoPayBtnSubmit">Pay <span id="blockoPayBtnCost"></span>BTC</button>
						</div>
					</form>
					
					<div id="blockoPayBtnResponse">
						
						<p>
							<span id="blockoPayBtnQrCode"></span>
							Send exactly <strong id="blockoPayBtnBTCAmount"></strong> to <strong id="blockoPayBtnBTCAddress"></strong>
							
						</p>
						
						<div class="ticker clearfix">
							<div class="time-container"><span id="minutes-num-container" class="time-num">--</span> <span id="minutes-text-container" class="time-text">minutes</span></div>
							<div class="time-container"><span id="seconds-num-container" class="time-num">--</span> <span id="seconds-text-container" class="time-text">seconds</span></div>
							<div id="expired"></div>
							<div class="time-progress"><div id="prog" class="prog"></div></div>
						</div>
						
						<div id="btcConversion"><span id="blockoPayBtnCurAmount"></span> &lt;-&gt; <span id="blockoPayBtnBTCEqui"></span> BTC</div>
						
					</div>
					
					<div id="blockoPayBtnSuccess">
						
						<p class="message">
							<span id="blockoPayBtnTick">&#10004;</span>
							Payment Done.							
						</p>
						
						<p>Thank you, your order has been received.</p>
						
					</div>
					
				</div>
			</div>
		</div>
	</div>

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<!-- Latest compiled and minified JavaScript -->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="/jquery.qrcode.min.js"></script>
	
	<script>
		var blockoCurrency = '';
		var blockoAmount = 0;
		var blockBtcAmount = 0;
		var startTime = '';
		var paymentMinutes = 10;
		var uid= '';	
		var timer;
		var blockoURL = "http://localhost:8080/api/button";
		var blockoActionURL = "http://localhost:8080/merchant_order/";
		var blockoFieldsMaster = {
			'0': {
				'id': 'blockoPayBtnnmail',
				'name': 'email',
				'label': 'Email',
				'type': 'email',
			},
			'1': {
				'id': 'blockoPayBtnname',
				'name': 'name',
				'label': 'Name',
				'type': 'text',
			},
			'2': {
				'id': 'blockoPayBtnaddress',
				'name': 'address',
				'label': 'Address',
				'type': 'textarea',
			}
		};
		
		$("body").on("click", "#blockoPayBtn", function(e) {
			e.preventDefault();
			var button = $(this);
			uid = button.data('uid').trim();
			if(uid == '') {
				alert("Error! Invalid Pay-button configuration. UID missing.");
			}
			
			$('#blockoPayBtnForm').html('');
			$('#blockoPayBtnForm').css('display', 'block');
			
			$('#blockoPayBtnQrCode').html('');
			$('#blockoPayBtnBTCAmount').html('');
			$('#blockoPayBtnBTCAddress').html('');
			$('#seconds-num-container, #minutes-num-container').html('--');
			$('#prog').css('width', 0);
			clearTimeout(timer);
			$('#blockoPayBtnResponse').css('display','none');
			$('#blockoPayBtnSuccess').css('display','none');
			
			$.ajax({
				url: blockoURL,
				data: {"uid": uid},
				type: 'GET',
				crossDomain: true,
				timeout: 10000,
				dataType: 'text',
				
				success : function(data){
					var response = jQuery.parseJSON(data);
					
					var productCode         = response.code;
					var productName         = response.code;
					var productDescription  = response.description;
					var fieldsMask          = response.fields_mask;
					var currency            = response.currency;
					var cost                = response.value;
					var uid                 = response.uid;
					
					blockoCurrency = currency;
					blockoAmount = cost;
					
					var finalFields = [(fieldsMask&1)>0, (fieldsMask&2)>0, (fieldsMask&4)>0];
					var finalFields = [];
					
					var n = 0;
					for(i = 0; i < Object.keys(blockoFieldsMaster).length; i++) {
						if(fieldsMask&(Math.pow(2, i))) {
							finalFields.push(blockoFieldsMaster[i]);
						}
					};
					
					var form = $("#blockoPayBtnForm");
					var responseArea = $("#blockoPayBtnResponse");
					
					if(finalFields.length == 0) {
						form.css('display', 'none');
						responseArea.css('display', 'block');
						return;
					}
					
					form.html('');
					
					$.each(finalFields, function(index, value) {
						if(value['type'] != 'textarea') {
							form.append("<div class='form-group'><input type='" + value['type'] + "' class='form-control' id='" + value['id'] + "' name='" + value['name'] + "' required placeholder='" + value['label'] + "'></div>");
						} else {
							form.append("<div class='form-group'><textarea class='form-control' id='" + value['id'] + "' name='" + value['name'] + "' required placeholder='" + value['label'] + "'></textarea>");
						}
					});
					
					form.append("<div class='form-group centered'><button type='submit' class='btn btn-warning' id='blockoPayBtnSubmit'>Pay <span id='blockoPayBtnCost'>" + cost + "</span> " + currency + "</button></div>");
					
					formAction = blockoActionURL + uid;
					form.attr('action', formAction);
					
					var blockoModal = $("#blockoPayModal");
					blockoModal.find('.modal-title').html('');
					blockoModal.find('.modal-title').html(productName + "<small>" + productDescription + "</small>");
					
					blockoModal.modal('show');
				
				}, error : function(httpReq,status,exception) {
					
				}
			});
			
		});
		
		$("body").on('submit', '#blockoPayBtnForm', function(e) {
			$("#blockoPayBtnGeneralError").css('display', 'none');
			e.preventDefault();
			
			var form = $(this);
			var submitButton = form.find('#blockoPayBtnSubmit');
			
			var messageBox = form.find('.blockoPayBtnMessage');
			messageBox.html('');
			
			var origButtonHTML = submitButton.html();
			submitButton.attr('disabled', 'disabled');
			submitButton.html('<img src="data:image/gif;base64,R0lGODlhEgASAMQaAHl5d66urMXFw3l5dpSUk5WVlKOjoq+vrsbGw6Sko7u7uaWlpbm5t3h4doiIhtLSz4aGhJaWlsbGxNHRzrCwr5SUkqKiobq6uNHRz4eHhf///wAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQFCgAaACwAAAAAEgASAAAFaqAmjmRplstyrkmbrCNFaUZtaFF0HvyhWRZNYVgwBY4BEmFJOB1NlYpJoYBpHI7RZXtZZb4ZEbd7AodFDIYVAjFJJCYA4ISoI0hyuUnAF2geDxoDgwMnfBoYiRgaDQ1WiIqPJBMTkpYaIQAAIfkEBQoAGgAsAQABABAAEAAABWSgJo4aRZEoeaxHOiqKFsyBtizopV9ynfwJ0o43MhgNKAYjZbGQJBLXKBLRIK4IaWFbEHgFUoKYoPFKRZUK6fFIORwojBxDytgzpDkdANDc8SQTExp8fBoQEGcDiwNnJA0NLiEAACH5BAUKABoALAEAAQAQABAAAAVloCaOmqKQKHmtVzpKksa2FIUiOKIxjHb8B5JgKCAFjgHUMHUkPR6u0WKhwVgx0YQ2ccW6DGCDZjKJiiwWEgCQikRQ6zWpQC+QBviBxuHQEP4EKA0NGhmGGRoVFWaHiGYjEBAuIQAAIfkEBQoAGgAsAQABABAAEAAABWSgJo6aJJEoiaxIOj6PJsyCpigopmNyff0X0o43AgZJk0mKwSABAK4RhaJ5PqOH7GHAHUQD4ICm0YiKwCSHI7VYoDLwDClBT5Di8khEY+gbUBAQGgWEBRoWFmYEiwRmJBUVLiEAACH5BAUKABoALAEAAQAQABAAAAVloCaO2vOQKImtWDoCgMa2koTCsDZNGuIjpIFwQBIYBahGI2UkORyukUKhyVgz0Yv2csW6thcNBBIVMRikSCRFoaAK8ALpQD+QCHiCZrHQBP4BKBUVGgmGCX6BUQaMBmUkFhYuIQAAIfkEBQoAGgAsAQABABAAEAAABWagJo4aAJAoaZrp6DjaIA/a86BZnmlNo2FADEm3GwWFJAgkNZmQIpHWSCLRFK4FKWKLIHgJUoFYoKlUpCIxabFIKRSohDxButgvJIPeoKFQNHd4JBYWGgeHBxoMDGgBjgFoJI4tIQAAIfkEBQoAGgAsAQABABAAEAAABWSgJo6a45Aoma1ZOkaRxrYAgBZ4oUGQVtckgpBAGhgHqEol1WiQFgvX6PHQJK4JKWaLMXgNWq7GYpGKJhMShZKSSFCH+IGEqCNIgXxAo1BoBIACKHkaF4YXf4JSh4hmIwwMLiEAACH5BAUKABoALAEAAQAQABAAAAVloCaOWhSRKFmsRToui0bMhOY4aKInWlVpmWCGZCgaSMIhyWJJQSAkCsU1AgA0h+yBarUGvgHqYDzQfKmiRoOkUKQeD9RlfiFh7hgSvS6RaPB5JAwMGgiGCBoTE2gCjQJoJI0uIQAAOw==" width="16">');
			
			var postData = form.serializeArray();
			var error = 0;
			$.each(postData, function(index, value) {
				var name = value['name'];
				var value = value['value'].trim();
				var id = form.find('[name="'+name+'"]').attr('id');
				$('#'+id).siblings('.help-block').remove();
				$('#'+id).parent('.form-group').removeClass('error');
				
				if( ( ! value) || (value == '') ) {
					error = 1;
					$('#'+id).parent('.form-group').addClass('error');
					$('#'+id).after("<small class='help-block error text-danger'>" + 'Invalid input' + "</small>");
				}
				
				if( name == 'email' && (validateEmail(value) == false) ) {
					error = 1;
					$('#'+id).parent('.form-group').addClass('error');
					$('#'+id).after("<small class='help-block error text-danger'>" + 'Invalid email' + "</small>");
				}
			});
			
			if(error == 1) {
				submitButton.html(origButtonHTML);
				submitButton.removeAttr('disabled');
				return;
			}
				
			var formURL = form.attr('action');
			var methodType = 'POST';
			
			$.ajax({
				url: 'http://localhost:8080/api/merchant_order/' + uid,
				type: methodType,
				contentType: false,
				processData: false,
				data: '{}',
				
				success: function(response, textStatus, jqXHR) {
					console.log(response);                 
					
					var btcAddress = response.address;
					var btcAmount = response.satoshi/1.e08;
					var amount = blockoAmount; 
					var currency = blockoCurrency;
					
					form.css('display', 'none');
					$('#blockoPayBtnQrCode').qrcode(btcAddress);
					
					$('#blockoPayBtnCurAmount').html(amount + ' ' + currency);
					$('#blockoPayBtnBTCEqui').html(btcAmount);
					$('#blockoPayBtnBTCAmount').html(btcAmount + 'BTC');
					$('#blockoPayBtnBTCAddress').html(btcAddress);
					
					var minutes = paymentMinutes;
					now = new Date();
					startTime = now;
					deadline = now.getTime() + minutes*60000;
					CountDownTimer(deadline, 'newcountdown');
					$('#blockoPayBtnResponse').css('display', 'block');
					
					if(response.success === true) {
						
						var btcAddress = response.btc_address;
						var btcAmount = response.btc_address;
						return;
					} else {
						
						return;
					}
				},
				error: function(jqXHR, textStatus, errorThrown) {}
			});
		});
		
		function CountDownTimer(dt, id) {
			var end = new Date(dt);
			var _second = 1000;
			var _minute = _second * 60;
			var _hour = _minute * 60;
			var _day = _hour * 24;
			
			function showRemaining() {
				var now = new Date();
				var distance = end - now;
				if (distance < 0) {
					clearInterval(timer);
					$(".time-container").remove();
					$("#prog").remove();
					document.getElementById("expired").innerHTML = '<div class="alert alert-danger">Sorry! This payment window has expired.</div>';
					return;
				}
				var days = Math.floor(distance / _day);
				var hours = Math.floor((distance % _day) / _hour);
				var minutes = Math.floor((distance % _hour) / _minute);
				var seconds = Math.floor((distance % _minute) / _second);
				
				minutes = minutes > 9 ? "" + minutes: "0" + minutes;
				seconds = seconds > 9 ? "" + seconds: "0" + seconds;
				
				var base_date = startTime;
				var total_distance = end - base_date;
				var passed_distance = now - base_date;
				
				var time_percent = 100 - ((passed_distance/total_distance) * 100);
				
				if(time_percent <= 99) {
					blockoPayBtnShowSuccess();
				}
				
				document.getElementById('minutes-num-container').innerHTML = minutes;
				document.getElementById('minutes-text-container').innerHTML = 'minutes';
				
				document.getElementById('seconds-num-container').innerHTML = seconds;
				document.getElementById('seconds-text-container').innerHTML = 'seconds';
				
				document.getElementById("prog").style.width = time_percent+"%";
				
			}

			timer = setInterval(showRemaining, 1000);
			
		}
		
		function blockoPayBtnShowSuccess() {
			$('#blockoPayBtnForm').css('display', 'none');
			clearTimeout(timer);
			$('#blockoPayBtnResponse').css('display','none');
			$('#blockoPayBtnSuccess').css('display','block');
		}
		
	</script>
	<script>
		function validateEmail(email) {
			var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
			return re.test(email);
		}
	</script>
</body>

</html>
